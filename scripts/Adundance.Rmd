---
title: "Gamete Abundance Analysis"
author: "jillashey"
date: "2023-04-10"
output: html_document
---

This script will analyze gamete abundance in Astrangia poculata over time. The data is separated into 3 treatments (ambient temperature, high temperature, field). 

## Load packages 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library("RColorBrewer")
```

## Load data & select specific columns 
```{r}
Abundance <- read.csv("data/Abundance.csv", header = T, na.strings = c("", "NA")) %>% 
  select(Coral.ID, Treatment, Timepoint, Sex, Abundance.of.Stage.One, Abundance.of.Stage.Two, Abundance.of.Stage.Three, Abundance.of.Stage.Four, Abundance.of.Stage.Five, Total.Gamates)

######### Include Site eventually 
```

## Select Female 
```{r}
Abundance_female <- Abundance %>% 
  filter(Sex == "Female") 
```

### Calculate relative proportion of each stage 
```{r}
Abundance_female <- Abundance_female %>%
  mutate(rel_prop_stage1 = (Abundance.of.Stage.One / Total.Gamates) * 100,
         rel_prop_stage2 = (Abundance.of.Stage.Two / Total.Gamates) * 100, 
         rel_prop_stage3 = (Abundance.of.Stage.Three / Total.Gamates) * 100, 
         rel_prop_stage4 = (Abundance.of.Stage.Four / Total.Gamates) * 100,
         rel_prop_stage5 = (Abundance.of.Stage.Five / Total.Gamates) * 100)
```

### Change data from wide to long 
```{r}
Abundance_female_long <- gather(Abundance_female, stage, value, rel_prop_stage1:rel_prop_stage5) %>% 
  select(Coral.ID, Treatment, Timepoint, Sex, stage, value) %>% 
  na.omit()
```

### SUMMARIZE DATA
Contingency plot 

### Plot
```{r}
female_abund_plot <- ggplot(Abundance_female_long, aes(fill=stage, y=value, x=Timepoint)) + 
    geom_bar(position="fill", stat="identity", color = "black") +
    scale_fill_manual(values = brewer.pal(n=4, name = "Blues")) +
    theme_classic()
female_abund_plot



ggplot(Abundance_female_long, aes(fill=stage, y=value, x=Timepoint)) + 
    stat_summary(fun.y=sum, geom="bar", colour="black", position = "fill", stat = "identity") +
    #geom_bar(position="fill", stat="identity", color = "black") +
    scale_fill_manual(values = brewer.pal(n=4, name = "Blues")) +
    scale_y_continuous(expand = c(0, 0)) +
    ylab("Relative Proportion") +
    #scale_fill_discrete(labels=c('Stage 1', 'Stage 2', "Stage 3", "Stage 4")) +
    theme_classic() 
















female_abund_trt_plot <- ggplot(Abundance_female_long, aes(fill=stage, y=value, x=Timepoint)) + 
    geom_bar(position="fill", stat="identity") + 
    facet_wrap(~Treatment)
female_abund_trt_plot

ggsave("output/Female_Gamete_Abundance.pdf", female_abund_plot)
ggsave("output/Female_Gamete_Abundance_Treatment.pdf", female_abund_trt_plot)
```

## Select Male 
```{r}
Abundance_male <- Abundance %>% 
  filter(Sex == "Male") 
```

### Calculate relative proportion of each stage 
```{r}
Abundance_male <- Abundance_male %>%
  mutate(rel_prop_stage1 = (Abundance.of.Stage.One / Total.Gamates) * 100,
         rel_prop_stage2 = (Abundance.of.Stage.Two / Total.Gamates) * 100, 
         rel_prop_stage3 = (Abundance.of.Stage.Three / Total.Gamates) * 100, 
         rel_prop_stage4 = (Abundance.of.Stage.Four / Total.Gamates) * 100,
         rel_prop_stage5 = (Abundance.of.Stage.Five / Total.Gamates) * 100)
```

### Change data from wide to long 
```{r}
Abundance_male_long <- gather(Abundance_male, stage, value, rel_prop_stage1:rel_prop_stage5) %>% 
  select(Coral.ID, Treatment, Timepoint, Sex, stage, value) %>% 
  na.omit()
```

### Plot
```{r}
ggplot(Abundance_male_long, aes(fill=stage, y=value, x=Timepoint)) + 
    stat_summary(fun.y=sum, geom="bar", colour="black", position = "fill", stat = "identity") +
    #geom_bar(position="fill", stat="identity", color = "black") +
    scale_fill_manual(values = brewer.pal(n=5, name = "Blues")) +
    scale_y_continuous(expand = c(0, 0)) +
    ylab("Relative Proportion") +
    #scale_fill_discrete(labels=c('Stage 1', 'Stage 2', "Stage 3", "Stage 4")) +
    theme_classic() 



male_abund_plot <- ggplot(Abundance_male_long, aes(fill=stage, y=value, x=Timepoint)) + 
    geom_bar(position="fill", stat="identity")
male_abund_plot

male_abund_trt_plot <- ggplot(Abundance_male_long, aes(fill=stage, y=value, x=Timepoint)) + 
    geom_bar(position="fill", stat="identity") + 
    facet_wrap(~Treatment)
male_abund_trt_plot

ggsave("output/Male_Gamete_Abundance.pdf", male_abund_plot)
ggsave("output/Male_Gamete_Abundance_Treatment.pdf", male_abund_trt_plot)
```





